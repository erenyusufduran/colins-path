# Setting up Fabric on Kubernetes (Google Cloud)

Two tools for setting up the fabric network and comminies clusters. `kubectl`, `minikube`

### kubectl

- CLI for running commands against the k8s cluster.
- Commands are executed on the shell prompt.

### Minikube - Utility for local development

- K8s cluster is setup in a single VM
- Used for local development & experimentation

### Setup Workflow

1. create image and push to the docker.hub
2. setup fabric with kubectl for setting up the peers and the orderer as ports as minicube clusters.
3. Once the containers for the orderer and the peers has started, application channel need to be created and peers need to join the application channel.

## Minikube & Kubectl Installation on Host Machine

- minikube start --memory=4096
- kubectl get all

---

- `k8s`
  - `init-setup.sh`
    - Generate the crypto
    - Setup fabric config objects
  - `clean-all.sh`
    - Deletes the objects generated by `init-setup.sh `

### Fabric on Kubernetes

- Peer & Orderer launched as Pods.
- Pod restart should not impact the Ledger | State database
- Peer & Orderer should get automatically restarted on failure
- Peer & Orderer IP/Hostnames exposed outside the cluster

- Peer & Orderer = Pod - 1, 4
- ReplicaSet - 1, 3, 4
- StatefulSet - 1, 2, 3, 4

### Fabric setup on Kubernetes

1. Prepare the Docker images (optional)
   - docker build
   - docker push
   - `/images` folder
   - Within the image files are copied to the folder /var/hyperledger/config, all of the conf objects are there.
   - images/orderer there are a Dockerfile.
   - images/acme-peer there are a Dockerfile too.
2. Setup the Kubernetes YAML
   - `k8s/minikube` there are yaml file for conf.
   - replicas: 1 because we'll have single instance.
3. Launch the Orderer and Peer
   - `k8s/minicube`
   1. Setup the storage class
   2. Launch the orderer and check for errors
   3. Launch acme peer and check for errors
4. Initialize the peer and test.
   1. Launch the minikube dashboard
   2. Submit Channel Create Txn
   3. Join the airlinechannel channel & update anchor peer
   4. Validate using the test chaincode

## Production Considerations

Each organization decides independently. So not every org need to use K8s. There is a common misconception that if you are using k8s for fabric, then you have to use federation.

### Network Setup

With the cluster IP, the peers and orderer ports are not exposed to the outside world. In other words, fabric network cannot be created just with cluster IP. You have to expose the IP addresses for the orderer and the peer for setting up the fabric network.

You can do it in three ways;

- **NodePort** - Testing Only
- **LoadBalancer** - If you are using cloud provider, then the implementation of the load balancer will depend on the k8s service provider.
- **Ingress Controller**

### Setup CouchDB for State Database

You need to set up the persistent volume claim for couchDB and this container for couchDB will reside in the same pod as the peer.

- Peer container to use localhost for accessing couchDB.

### Setup the healtcheck

- Auto recovery if _pod | container_ fails.
- Recovery will not work if peer / orderer process fails.
  - Setup pod liveness probe.

### Spread Load Across Peers

- Leverage K8s flexibility to create additional peers.
  - Dedicated peer instances for application level queries.

---

- Orgs are free to decide their fabric instrastructure.
- Peer / Orderer IP need to be exposed outside of K8s cluster.
- Implement Liveliness probe.
- Setup CouchDB in peer pod.
- Setup multiple dedicated / isolated peer pods.

---

## Setup Fabric on Google K8s Engine

1. Setup Requirements

   Fabric network will have two member organizations, Acme and Budget. Acme will host an orderer of type SOLO and it will also host one Anchor peer. The Budget will host one peer. There will be one application channel and both the acme and budget will join this channel to transact using chaincode.

   **Stateful Set** met with our requirements. The sample network that we will create in k8s will consist of three stateful sets. _Acme Orderer_, _Acme Peer_, _Budget Peer_. Each of these stateful set pods will have associated **persistent volumes** that they will use for managing ledger and state data.

   In the `acloudfan/HLF-K8s-Cloud` repository, you will find multiple k8s definition YAML files.

2. Setup Fabric on Google K8s Engine

   Once the parties are up and running, we will log into the containers and create the channel and join the two peers to the application channel.

   To setup to images, we need to setup Dockerfile, and then push the Docker Hub. <a href="hub.docker.com/u/acloudfan">acloudfun docker</a>

   Then we will set up k8s cluster on Google Cloud.

   In google cloud, kubernetes engine and create cluster. Then connect and with shell `kubectl get all`, then get the repo with `git clone`

   Then launch the code editor and run

   - `cd HLF-K8s-Cloud`
   - `cd gcp`
   - `kubectl apply -f .`
   - `cd ..`
   - `kubectl apply -f .`

   Now we can see in workloads. Lets create the channel.

   - `kubectl exec -it acme-peer-0 /bin/bash`
   - `ls -la` there are some scripts.
   - `./submit-channel-create.sh`
   - `./join-channel.sh`
   - `peer channel list`
   - `./anchor-update.sh`
   - `kubectl exec -it budget-peer-0 /bin/bash`
   - `./fetch-channel-block.sh`
   - `./join-channel.sh`
   - `peer channel list`

   At this point fabric network setup on Google Cloud.

3. Test the Network

   In README.md file you can see the commands.
