# Setting up Fabric on Kubernetes (Google Cloud)

Two tools for setting up the fabric network and comminies clusters. `kubectl`, `minikube`

### kubectl

- CLI for running commands against the k8s cluster.
- Commands are executed on the shell prompt.

### Minikube - Utility for local development

- K8s cluster is setup in a single VM
- Used for local development & experimentation

### Setup Workflow

1. create image and push to the docker.hub
2. setup fabric with kubectl for setting up the peers and the orderer as ports as minicube clusters.
3. Once the containers for the orderer and the peers has started, application channel need to be created and peers need to join the application channel.

## Minikube & Kubectl Installation on Host Machine

- minikube start --memory=4096
- kubectl get all

---

- `k8s`
  - `init-setup.sh`
    - Generate the crypto
    - Setup fabric config objects
  - `clean-all.sh`
    - Deletes the objects generated by `init-setup.sh `

### Fabric on Kubernetes

- Peer & Orderer launched as Pods.
- Pod restart should not impact the Ledger | State database
- Peer & Orderer should get automatically restarted on failure
- Peer & Orderer IP/Hostnames exposed outside the cluster

- Peer & Orderer = Pod - 1, 4
- ReplicaSet - 1, 3, 4
- StatefulSet - 1, 2, 3, 4

### Fabric setup on Kubernetes

1. Prepare the Docker images (optional)
   - docker build
   - docker push
   - `/images` folder
   - Within the image files are copied to the folder /var/hyperledger/config, all of the conf objects are there.
   - images/orderer there are a Dockerfile.
   - images/acme-peer there are a Dockerfile too.
2. Setup the Kubernetes YAML
   - `k8s/minikube` there are yaml file for conf.
   - replicas: 1 because we'll have single instance.
3. Launch the Orderer and Peer
   - `k8s/minicube`
   1. Setup the storage class
   2. Launch the orderer and check for errors
   3. Launch acme peer and check for errors
4. Initialize the peer and test.
   1. Launch the minikube dashboard
   2. Submit Channel Create Txn
   3. Join the airlinechannel channel & update anchor peer
   4. Validate using the test chaincode

## Production Considerations

Each organization decides independently. So not every org need to use K8s. There is a common misconception that if you are using k8s for fabric, then you have to use federation.

### Network Setup

With the cluster IP, the peers and orderer ports are not exposed to the outside world. In other words, fabric network cannot be created just with cluster IP. You have to expose the IP addresses for the orderer and the peer for setting up the fabric network.

You can do it in three ways;

- **NodePort** - Testing Only
- **LoadBalancer** - If you are using cloud provider, then the implementation of the load balancer will depend on the k8s service provider.
- **Ingress Controller**

### Setup CouchDB for State Database

You need to set up the persistent volume claim for couchDB and this container for couchDB will reside in the same pod as the peer.

- Peer container to use localhost for accessing couchDB.

### Setup the healtcheck

- Auto recovery if _pod | container_ fails.
- Recovery will not work if peer / orderer process fails.
  - Setup pod liveness probe.

### Spread Load Across Peers

- Leverage K8s flexibility to create additional peers.
  - Dedicated peer instances for application level queries.

---

- Orgs are free to decide their fabric instrastructure.
- Peer / Orderer IP need to be exposed outside of K8s cluster.
- Implement Liveliness probe.
- Setup CouchDB in peer pod.
- Setup multiple dedicated / isolated peer pods.
