# Multi Org Setup with Root Certification Authority

Beginning of this initiative, it was decided that the network will be setup with the Orderer Organization and Acme Organization and then in phase two, we add the Budget Organization.

We have tried the network setup with the best crypto material generated by cryptogen tool. Going forward, we're going to add the CA server in this mix. So the identities for all the components in the network will be managed in the CA server.

- In test setup, there is `ca/multi-org-ca` in this folder there is a subfolders like `client` and `server`.
- `orderer/mult-org-ca`
- `peer/multi-org-ca`

## Fabric CA Server, Roles & Identities

There will be three roles in the multi org setup that we are going to create.

- **CA Server Admin**
  - Bootstrap identity created on the CA Server.
  - The Root CA server admin may be considerer as a super user from identity management perspective. They can manage any identity across all organizations.
- **Organization Admin**
  - There will three organization admins. These three elements will created by the RootCA server admin.
    - `acme-admin`
    - `budget-admin`
    - `orderer-admin`
  - The organization admin can carry out identitiy management actions against the other entities within their respective organization.
- Then each of these organization admins will create **Organization Identities**.
  - They will be human actors and they will be the **Peers**, **Ordering Service** and **Client (Application)** identities.
  - For the Organization Identity, the type and authority is set by the organization admin.

### CA Home Folders

- `ca`
  - `multi-org-ca` - **Root Folder:** All of the server and client related data folders for the fabrics here.
    - `server` - **Server Root Folder:** Root for the CA server.
      - `fabric-ca-server-config` managed in this folder.
        - We'll use `config/multi-org-ca/yaml.0`
        - `csr`
        - `affiliations` section include departments and organizations.
    - `client` - **Client Identities:** To manage the crypto for all of the identities.
      - `ca-server` - Home folder for the bootstrap identity (admin)
        - Admin will need to set the path to the admin folder in the environment variable `FABRIC_CA_CLIENT_HOME`
      - `acme`
      - `budget`
      - `orderer`

## CA Server Setup

1. Setup Root CA Server - `./server.sh start`
   - Set up the FABRIC_CA_SERVER_HOME variable.
     - export `FABRIC_CA_SERVER_HOME=ca/multi-org-ca/server`
   - Copy the `fabric-ca-server-config` from following to `./server`
     - `setup/config/multi-org-ca/yaml.0/fabric-ca-server-config.yaml`
   - Execute `fabric-ca-server start` command.
2. Enroll Admin Identity - `./server.sh enroll`
   - Set up the FABRIC_CA_CLIENT_HOME variable.
     - export `FABRIC_CA_CLIENT_HOME=ca/multi-org-ca/client/caserver/admin`
   - Copy yo `$FABRIC_CA_CLIENT_HOME` from yaml.0
   - Execute _enroll_ commmand for admin

## Register & Enroll Organization Identities

Setup for each admin is different. Org Identities created by the Org Admins.

- Enrollment for non-human actor carried out by Org admin
- Enrollment for human actor carried out by Identity Owner

1. As CA Admin **Registers Identities**
   - To set the `FABRIC_CA_CLIENT_HOME`
     - `. ./setclient.sh <ORG_NAME> <ENROLLMENT_ID>`
   - To create the necessary client folders for an identity
     - `mkdir -p $FABRIC_CA_CLIENT_HOME`
   - Create `acme/admin`, `budget/admin`, `orderer/admin` subfolders in client folder.
   - Copy client YAML files
2. As Org Admin Identity **Enroll**
   - `./register-enroll-admins.sh`
   - `fabric-ca-client identity list` as caserver admin

## Local MSP setup for Identities & Organizations

All identities **need the local MSP setup**, which is created on the local filesystem for the identity. It consists of multiple subfolders with crypto material. In this logical structure for the MSP, the same certificates are held in their own subfolder.

- There is a subfolder to hold **private key** for the identity. - `keystore`
- **Root CA Cert** - `cacerts`
- **ICA**
- **Signing Cert** - `signcerts`
- **Admin Certs** - `admincerts`

All our identities need admin certificates and they can be more than one certificate in the admin certificate subfolder.

The MSP folder for the identities get created as part of the enroll command.

### Exercise - MSP for User Identity

1.  Register & Enroll User Identity
    - `fabric-ca-client register & enroll`
    - `./add-admincerts.sh acme jdoe`
    1. As Acme Admin _Register_ the User identity
       - `. ./setclient.sh acme admin`
       - John Doe:
         - affiliation=acme.logistics
         - type=user
         - id=jdoe
         - secret=pw
    2. Setup the `fabric-ca-client-config`
       - `fabric-ca-client register --id.type user --id.name jdoe --id.secret pw --id.affiliation acme.logistics`
    3. As `John Doe`, enroll the identity
       - `fabric-ca-client enroll -u http://jdoe:pw@localhost:7054`
2.  Setup the MSP for User Identity
    1. Create the admincerts subfolder for `jdoe/msp`
    2. Copy ACME Admin's cert to the `jdoe/msp/admincerts`
       - `./add-admincerts.sh acme jdoe`

## Setup Organization MSP

Organization section of configtx there is a list of member organizations. Each of the organization, the local MSP directory need to be specified and this directory need to have the same structure.

MSP that we are referring to was generated by the `cryptogen tool`.

- MSP requires only two certificates:
  - Root CA Cert
  - Admin Cert
  - `./setup-org-msp.sh acme`

1. Create MSP subfolder structure
2. Copy Root CA Certificate
3. Copy Org Admin's Certificate

## Orderer Setup Tasks

One of the administrator uses `configtxgen` to generate to \*_Genesis Block_. Orderer depends on the availability of this genesis Block.

Orderer also depends on the identity that is creater for the orderer component and also depends on the availability of the orderer.yaml file.

Once the orderer is launch, it writes to the file system.

### Task for Setting Up the Orderer

1. Setup configtx.YAML file.
2. Generate the **Genesis Block**.
3. As orderer admin setup _orderer_ identity & **MSP**.
4. Setup orderer.YAML file and launch the orderer.

> _Orderer's identity_ is **NOT** the same as _Orderer Org Admin_ identity.

Phase 1 of multi-org setup, there will be only two organization. Orderer and Acme Organizations. Orderer Organization will be responsible for managing the orderer.

Administrators from the respective organizations will create the identities for their own organizations and the configuration of the components will be carried out by accessing the MSP generated.

---

For the `configtx.yaml`, we need to set up the two organizations under the organization section for the Orderer Organization. We will have the MSP directory pointing to the Orderer's MSP directory and the Acme Organization's MSP directory will point to the Acme MSP

There are two profiles and one of the profiles is `AirlineOrdererGenesis`, which is what we are going to use for generating the Genesis Block.

Under the application, you will find that we have only one organizations, which is Acme, because we haven't included the budget organization in phase one.

In the `orderer-config.yaml` file under the general section, we have set the GenesisMethod (BootstrapMethod) to the file and Genesis file is pointing to the `./airline-genesis.block`. The local MSP directory is pointing to the MSP for the Orderer Identity under the Orderer Organization.

_All scripts in `orderer/multi-org-ca`_

1. Generate the Genesis Block `./generate-genesis.sh`
   - `configtxgen -profile AirlineOrdererGenesis -outputBlock ./airline-genesis.block -channelID ordererchannel`
2. Setup the Orderer Identity & MSP
   1. As orderer admin register orderer identity `./register-enroll-orderer.sh`
   2. Copy `fabric-ca-client-config` to orderer CA client home.
   3. As orderer execute the enroll command
   4. Setup the orderer identity's MSP
