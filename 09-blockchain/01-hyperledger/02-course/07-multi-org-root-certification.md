# Multi Org Setup with Root Certification Authority

Beginning of this initiative, it was decided that the network will be setup with the Orderer Organization and Acme Organization and then in phase two, we add the Budget Organization.

We have tried the network setup with the best crypto material generated by cryptogen tool. Going forward, we're going to add the CA server in this mix. So the identities for all the components in the network will be managed in the CA server.

- In test setup, there is `ca/multi-org-ca` in this folder there is a subfolders like `client` and `server`.
- `orderer/mult-org-ca`
- `peer/multi-org-ca`

## Fabric CA Server, Roles & Identities

There will be three roles in the multi org setup that we are going to create.

- **CA Server Admin**
  - Bootstrap identity created on the CA Server.
  - The Root CA server admin may be considerer as a super user from identity management perspective. They can manage any identity across all organizations.
- **Organization Admin**
  - There will three organization admins. These three elements will created by the RootCA server admin.
    - `acme-admin`
    - `budget-admin`
    - `orderer-admin`
  - The organization admin can carry out identitiy management actions against the other entities within their respective organization.
- Then each of these organization admins will create **Organization Identities**.
  - They will be human actors and they will be the **Peers**, **Ordering Service** and **Client (Application)** identities.
  - For the Organization Identity, the type and authority is set by the organization admin.

### CA Home Folders

- `ca`
  - `multi-org-ca` - **Root Folder:** All of the server and client related data folders for the fabrics here.
    - `server` - **Server Root Folder:** Root for the CA server.
      - `fabric-ca-server-config` managed in this folder.
        - We'll use `config/multi-org-ca/yaml.0`
        - `csr`
        - `affiliations` section include departments and organizations.
    - `client` - **Client Identities:** To manage the crypto for all of the identities.
      - `ca-server` - Home folder for the bootstrap identity (admin)
        - Admin will need to set the path to the admin folder in the environment variable `FABRIC_CA_CLIENT_HOME`
      - `acme`
      - `budget`
      - `orderer`

## CA Server Setup

1. Setup Root CA Server - `./server.sh start`
   - Set up the FABRIC_CA_SERVER_HOME variable.
     - export `FABRIC_CA_SERVER_HOME=ca/multi-org-ca/server`
   - Copy the `fabric-ca-server-config` from following to `./server`
     - `setup/config/multi-org-ca/yaml.0/fabric-ca-server-config.yaml`
   - Execute `fabric-ca-server start` command.
2. Enroll Admin Identity - `./server.sh enroll`
   - Set up the FABRIC_CA_CLIENT_HOME variable.
     - export `FABRIC_CA_CLIENT_HOME=ca/multi-org-ca/client/caserver/admin`
   - Copy yo `$FABRIC_CA_CLIENT_HOME` from yaml.0
   - Execute _enroll_ commmand for admin

## Register & Enroll Organization Identities

Setup for each admin is different. Org Identities created by the Org Admins.

- Enrollment for non-human actor carried out by Org admin
- Enrollment for human actor carried out by Identity Owner

1. As CA Admin **Registers Identities**
   - To set the `FABRIC_CA_CLIENT_HOME`
     - `. ./setclient.sh <ORG_NAME> <ENROLLMENT_ID>`
   - To create the necessary client folders for an identity
     - `mkdir -p $FABRIC_CA_CLIENT_HOME`
   - Create `acme/admin`, `budget/admin`, `orderer/admin` subfolders in client folder.
   - Copy client YAML files
2. As Org Admin Identity **Enroll**
   - `./register-enroll-admins.sh`
   - `fabric-ca-client identity list` as caserver admin

## Local MSP setup for Identities & Organizations

All identities **need the local MSP setup**, which is created on the local filesystem for the identity. It consists of multiple subfolders with crypto material. In this logical structure for the MSP, the same certificates are held in their own subfolder.

- There is a subfolder to hold **private key** for the identity. - `keystore`
- **Root CA Cert** - `cacerts`
- **ICA**
- **Signing Cert** - `signcerts`
- **Admin Certs** - `admincerts`

All our identities need admin certificates and they can be more than one certificate in the admin certificate subfolder.

The MSP folder for the identities get created as part of the enroll command.

### Exercise - MSP for User Identity

1.  Register & Enroll User Identity
    - `fabric-ca-client register & enroll`
    - `./add-admincerts.sh acme jdoe`
    1. As Acme Admin _Register_ the User identity
       - `. ./setclient.sh acme admin`
       - John Doe:
         - affiliation=acme.logistics
         - type=user
         - id=jdoe
         - secret=pw
    2. Setup the `fabric-ca-client-config`
       - `fabric-ca-client register --id.type user --id.name jdoe --id.secret pw --id.affiliation acme.logistics`
    3. As `John Doe`, enroll the identity
       - `fabric-ca-client enroll -u http://jdoe:pw@localhost:7054`
2.  Setup the MSP for User Identity
    1. Create the admincerts subfolder for `jdoe/msp`
    2. Copy ACME Admin's cert to the `jdoe/msp/admincerts`
       - `./add-admincerts.sh acme jdoe`

## Setup Organization MSP

Organization section of configtx there is a list of member organizations. Each of the organization, the local MSP directory need to be specified and this directory need to have the same structure.

MSP that we are referring to was generated by the `cryptogen tool`.

- MSP requires only two certificates:
  - Root CA Cert
  - Admin Cert
  - `./setup-org-msp.sh acme`

1. Create MSP subfolder structure
2. Copy Root CA Certificate
3. Copy Org Admin's Certificate

## Orderer Setup Tasks

One of the administrator uses `configtxgen` to generate to \*_Genesis Block_. Orderer depends on the availability of this genesis Block.

Orderer also depends on the identity that is creater for the orderer component and also depends on the availability of the orderer.yaml file.

Once the orderer is launch, it writes to the file system.

### Task for Setting Up the Orderer

1. Setup configtx.YAML file.
2. Generate the **Genesis Block**.
3. As orderer admin setup _orderer_ identity & **MSP**.
4. Setup orderer.YAML file and launch the orderer.

> _Orderer's identity_ is **NOT** the same as _Orderer Org Admin_ identity.

Phase 1 of multi-org setup, there will be only two organization. Orderer and Acme Organizations. Orderer Organization will be responsible for managing the orderer.

Administrators from the respective organizations will create the identities for their own organizations and the configuration of the components will be carried out by accessing the MSP generated.

---

For the `configtx.yaml`, we need to set up the two organizations under the organization section for the Orderer Organization. We will have the MSP directory pointing to the Orderer's MSP directory and the Acme Organization's MSP directory will point to the Acme MSP

There are two profiles and one of the profiles is `AirlineOrdererGenesis`, which is what we are going to use for generating the Genesis Block.

Under the application, you will find that we have only one organizations, which is Acme, because we haven't included the budget organization in phase one.

In the `orderer-config.yaml` file under the general section, we have set the GenesisMethod (BootstrapMethod) to the file and Genesis file is pointing to the `./airline-genesis.block`. The local MSP directory is pointing to the MSP for the Orderer Identity under the Orderer Organization.

_All scripts in `orderer/multi-org-ca`_

1. Generate the Genesis Block `./generate-genesis.sh`
   - `configtxgen -profile AirlineOrdererGenesis -outputBlock ./airline-genesis.block -channelID ordererchannel`
2. Setup the Orderer Identity & MSP
   1. As orderer admin register orderer identity `./register-enroll-orderer.sh`
   2. Copy `fabric-ca-client-config` to orderer CA client home.
   3. As orderer execute the enroll command
   4. Setup the orderer identity's MSP

## Peer and Channel Setup Tasks

Leader peers maybe statically created in the organization or the leader peer may be dynamic.

- Leader peer pulls the block data from the orderer and then this block data is passed on to other peers in the network.
- So each of the peer receives and send data to other peers.
- Peer can also pull log data from other peers.
- Each of the peer also forwards the data to random number of peers.

Each of the organization admins can set up the peers within their organization as their desire. They can add and update the peers their organizations. So adding a new peer does not require authorization from admins of other organizations. These peers within the organization are not discoverable from outside the organization. **Only the anchor peers are discoverable in the network**, and this _discoverability is enabled by way of the anchor peer declaration in the `configtx.yaml` file_.

> Adding an anchor peer, admins need to submit a config update transaction, and the policy defines how many administration need to sign that transaction.

**Peer binary has two dependencies**. First one is on the **peer's MSP** and the peers MSP is created by the organization admin. To create the peer MSP, the peer identity need to be created first. The peer binary uses the peer MSP and also requires the **core.yaml to be available**. `core.yaml` has the appropriate set of parameters for the peer binary. Once the peer has launched writes to the filesystem.

1. Organization admin sets up the _peer identity_.
2. Organization admin sets up the `core.yaml`.

### Application Channel Creation

One of the organization administrator create the `configtx.yaml` file profile for the application channel, which is then fed to the `configtxgen` tool to create the **Channel Transaction File**.

This channel transaction file need to be signed by one or more organization admins. Number of signatures depends on the policy that is applied for the _config update transaction_.

Once the channel transaction file has been signed by the number of administrators, one of the admins use the `configtxgen tool` to submit the channel transaction.

So in effect, there are 3 tasks;

1. One of the Org _Admin_ creates the **channel transaction file**.
2. Organization _Admins_ _sign_ the channel transaction file.
3. One of the Org Admin submits the signed channel create transaction.

To make the peer join the channel, it has to be launched. Once the peer has launched successfully, the argument can execute the joined channel command to make the peer join the application channel.

There are 2 tasks for peer to join channel;

1. Launch the anchor peer for organization.
2. Organization admins execute join channel for peer.

- Setup tasks for all peers is the same except the Anchor Peer.
- In Anchor Peer we need to define Anchor Peer Setup in the `configtx.yaml` file.
- Anchor peers also be added by way of config update transactions.
