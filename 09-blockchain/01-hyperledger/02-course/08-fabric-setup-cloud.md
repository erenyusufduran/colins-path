# Fabric Setup on the Cloud

Target infrastructure on AWS will look like below.

We will have a VPC in which there will be three virtual machines are easy to instances, **first for the orderer**, **second and third for the Anchor peers for the Acme Organization** and **the Budget Organization**.

### Network Considerations

- VM must be reachable or file transfer & SSH. We will be using our host machine to connect with these cloud VMS.
- VM will connect over TCP with other VMs.
  - If all of the VMs are set up in the same VPC, then there is no problem.
  - If the VMs are set in different VPCs, then there will be need to configure the network path between the VMs on certain ports.
- Use of fabric tools from Remote machines will require the appropriate ports to be exposed.
  - For example, if you are using the peer binary, it would need access to port 7051 and 7052 on the peer VMs.
- _Open Security Group_
  - In production, it is not recommended.

---

- `cloud`
  - `artefacts` - Artifacts generated by scripts
  - `bins`
    - `orderer` - Shell scripts to be copied to orderer VM
    - `peer` - Shell scripts to be copied to peer VM
  - Shell scripts and configuration files

### Cloud Setup Tasks

1. Setup the _crypto material_
2. Setup the _cloud VM + Config Setup_
3. Setup the Orderer (type=solo)
4. Setup the _Peers_ (Acme)

## Crypto Setup

1. Fabric CA will be used generating the crypto.
2. Organization _may_ setup a (intermediate) certificate authority.
3. Admin's in the Orgs will be responsible for registration / enrollments.

## Setup the crypto material

1. Generate the crypto material using `cryptogen tool`
2. Seperate the crypto folders for the various orgs. `./gen-crypto.sh`
   - This script generates our files with crypto material under the artifact subfolder.
     - Create the Organization MSP to be used by `orgs-msp.tar`
     - Create the MSP for Orderer `orderer-msp.tar`
     - Create the MSP for Acme `acme-msp.tar`
     - Create the MSP for Budget `budget-msp.tar`
   - `orgs-msp.tar` file will be used for the duration of the **Genesis Block**, which will then be used for **setup of the Orderer**.
   - Other three tar files will be used for **setting up the local MSP for the organizations**.

## Setup Cloud VM and Configuration Files

We will be setting three VMs on the cloud. These three VMs will be created on AWS.

### For Production Setup

1. Virtual machines will be owned by different organizations
2. Fixed public IP addresses (or VPN secure) will be assigned to peer VM
3. Sizing of VM will be done based on estimated loads
4. Multiple peers will be setup by each organization for scalability and availability.

> After the restart need network configuration again.

**EC2 Public IP addresses**

- Orderer - 172.31.85.13
- Acme - 172.31.92.92
- Budget - 172.31.25.85

We will use this IP addresses in `./set-env.sh` as well as in the `configtx.yaml`

### Configuration Setup

1. Setup the IP address for VMs in _script_
   - Set public IP of Orderer under the `cloud` folder.
   - `set-env.sh` & `bins/set-env.sh`
2. Setup the IP addresses for Orderer and two peers in the `configtx.yaml`
   - Update configtx.yaml with EC2 IPs.
3. Generate the Genesis Block & Create Channel Transaction file.
   - Execute the `gen-genesis-channeltx.sh`

## Orderer Setup

### For Production Setup

1. Kafka cluster will be used instead of Solo
2. Multiple organization will host the orderer instances
3. Each Org admin will create the credentials for the Orderer instance

---

1. FTP files to Orderer VM
   - airline-genesis.block and orderer-msp.tar need to be FTPied.
   - Then you need to FTP all of the files under the `cloud/bins/orderer` folder.
2. Setup the Orderer
   - SSH to _Orderer_ VM - connect from aws
     - `chmod 775 orderer`
     - `sudo mv orderer /usr/local/bin`
     - `orderer version`
3. Setup Orderer MSP & Launch
   - `tar xvf orderer-msp.tar`
   - `chmod 755 *.sh`

## Setup the Peers (Acme & Budget)

1. Each organization will be responsible for setting their own peers
2. Fixed Public IP addresses assigned to anchor peers
3. Setup multiple peers in the organization

---

1. FTP files to peer vm
   - acme-msp.tar and airline-channel.tx
   - `cloud/bins/peer` files
2. Setup the peer
   - SSH to Peer Virtual Machine
     - `chmod 755 peer`
     - `chmod 755 *.sh`
     - `sudo ./docker.sh`
     - `sudo mv peer /usr/local/bin`
3. Setup environment scripts & execute
   - `nano set-env.sh` and change CORE_PEER_LOCALMSPID
   - `. ./set-env.sh`
4. Setup peer local MSP
   - `tar xvf acme-msp.tar`
5. Create Airline Channel
   - `./create-airline-channel.sh`
6. Launch peer & join airline channel
   - `./launch.sh`
   - `./join-airlinechannel.sh`

## Testing the Cloud Setup

Use these scripts `set-env.sh`, `cc-test.sh` for cloud setup.

### Testing Strategy

- Install a common chaincode on multiple peers in the network.
- Instantiate chaincode on one of the peers.
- Execute `invoke | query` again chaincode on different peers.

### Testing Set up Options

- Setup test code on all peer VMs, execute on VM
  - Additional component installation needed.
- Setup a common cloud VM for testing.
  - Cloud VM setup needed
  - You may use private IP address for components.
- Setup a local VM for testing.
  - You may use existing HOST/VM we are using.

### Local VM Testing

We dont need to carry out any tasks for the VM that we are using on our local machine.

- `./cc-test.sh install`
  1. Package `lifecycle chaincode package`
  2. Install `lifecycle chaincode install`
  3. Approves `lifecycle chaincode approveformyorg`
- `cc-test.sh instantiate`
  1. Commit `lifecycle chaincode commit`
  2. Initialize `lifecycle chaincode invoke -isInit`
- `cc-test.sh invoke`
  - `peer chaincode invoke`
- `cc-test.sh query`
  - `peer chaincode query`
